<!DOCTYPE html>
<meta charset="utf-8"/>
<svg width="1000" height="525" stroke="#fff" stroke-width="0.5"></svg>

<script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
<script src="https://d3js.org/d3-contour.v1.min.js" charset="utf-8"></script>
<script src="https://d3js.org/d3-selection-multi.v1.min.js" charset="utf-8"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js" charset="utf-8"></script>

<script language="javascript" type="text/javascript" src="p5.js"></script>
<script language="javascript" src="p5.dom.js"></script>


<script>

// D3 part 

// Populate a grid of n×m values where 0 < x < 100 and 0 < y < 5000
var n = 100, m = 100, values = new Array(n * m);
for (var j = m-1, k = 0; j >= 0; --j) {
  for (var i = 0; i < n; ++i, ++k) {
    values[k] = ABratio(i / 100, j * 50);
  }
}

d3.select("body").style("background-color", d3.rgb(240,240,240))

var svg = d3.select("svg"),
    //width = +svg.attr("width")-200,
    //height = +svg.attr("height"),
    width = 500;
    height = 500

var thresholds = d3.range(0,4,0.4)
    .map(function(p) { return Math.pow(10, p); });

var contours = d3.contours()
    .size([n, m])
    .thresholds(thresholds);

/*
var colour = d3.scaleLog()
//var colour = d3.scaleLinear()
    .domain(d3.extent(thresholds))
    .interpolate(function() { return d3.interpolateYlGnBu; });
*/

var colour = d3.scaleThreshold()
    //.domain(d3.extent(thresholds)) // this is just min() and max()
    .domain(thresholds)
    .range(['#8e0152','#c51b7d','#de77ae','#f1b6da','#fde0ef','#e6f5d0','#b8e186','#7fbc41','#4d9221','#276419'])

svg.selectAll("path")
  .data(contours(values))
  .enter().append("path")
    .attr("d", d3.geoPath(d3.geoIdentity().scale(width / n)))
    .attr("fill", function(d) { return colour(d.value); })
    .on( "mouseover", function(d) { which_slice=thresholds.findIndex(x => x==d.value); } )
    .on( "mouseout", function(d) { which_slice=-1 } );


function ABratio(p, gap)
{
    T = 5000
    return p*T/((1-p)*(T-gap)) + 1
}


// make colourbar

var blockheight = (height-40)/thresholds.length

cbar_labels = ['>99.9%','99.8-99.9%','99.6-99.8%','99.2-99.6%','90.8-99.2%','95-98%','87-95%','68-87%','20-68%','<20%']
cbar_labels[1] += '\u25c4 Data is in\nthis range'

for (var i=0; i<thresholds.length; i++)
{
    svg.append('rect')
       .attrs({ x:width+25, y:20+i*blockheight, width:30, height:blockheight,
                fill:colour(thresholds[thresholds.length-1-i]) })

    svg.append('text')
        .attr("x", width+60)
        .attr("y", 50+i*blockheight)
        .style("font-family", "sans-serif")
        .style("font-size", "20px")
        .text(cbar_labels[i])
}


/*
var my_image = svg.append('image')
    .attr('xlink:href','../images/tent.svg')
    .attr('x', 600)
    .attr('y', 100)
    .attr('width', 100)
    .attr('height', 100)
*/


/*
// make axes
svg.append('rect')
    .attrs({ x:-5, y:20, width:30, height:blockheight,
            fill:"lightgrey" })
*/

/*

// P5 part
function setup()
{
    // create canvas
    createCanvas(windowWidth-20, windowHeight-20);
    textFont("sans",25);
}

function draw_axes(plotsize)
{
	axisWidth = 7
	axisLength = plotsize+20
	strokeWeight(0)
	fill(150)

	push();
	rect(0, 0, axisWidth, axisLength)
	rect(2, 1*plotsize/6+30-axisWidth, -20, axisWidth)
	rect(2, 3*plotsize/6+30-axisWidth, -20, axisWidth)
	rect(2, 5*plotsize/6+30-axisWidth, -20, axisWidth)
	
	strokeWeight(0)
        text("Small",  -95, 1*plotsize/6+35);
        text("Medium", -125, 3*plotsize/6+35);
        text("Large",  -95, 5*plotsize/6+35);
	pop();
	
	push();
	translate(0,axisLength);
	rotate(-PI/2);
	rect(0, 0, axisWidth, axisLength)
	rect(2, 1*plotsize/6, -20, axisWidth)
	rect(2, 3*plotsize/6, -20, axisWidth)
	rect(2, 5*plotsize/6, -20, axisWidth)

	strokeWeight(0)
        text("Small",  -95, 1*plotsize/6+12);
        text("Medium", -125, 3*plotsize/6+12);
        text("Large",  -95, 5*plotsize/6+12);
	pop();
}

function draw()
{
	dx_axes = 150
	dy_axes = 0
	plotsize = 300
        background(240)

	push();
	translate(dx_axes,dy_axes);
	draw_axes(plotsize);
	pop();
}

*/

</script>
